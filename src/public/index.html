<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PesaDB Transaction Manager</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }

        h1 {
            color: #1a1a1a;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            color: #555;
            font-weight: 600;
        }

        input,
        button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 8px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
            color: white;
        }

        button.delete {
            background: #dc3545;
            padding: 6px 12px;
            font-size: 12px;
        }

        button.delete:hover {
            background: #a71d2a;
        }

        .error {
            color: red;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .metric-box {
            flex: 1;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }

        .metric-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        /* Terminal Window - Professional/Clean */
        .terminal-container {
            margin-top: 20px;
            border: 1px solid #333;
            border-radius: 4px;
            background: #1e1e1e;
            display: none;
            /* Hidden by default */
        }

        .terminal-header {
            background: #333;
            color: #fff;
            padding: 5px 10px;
            font-size: 12px;
            font-family: monospace;
            border-bottom: 1px solid #444;
        }

        .terminal-body {
            height: 200px;
            overflow-y: auto;
            padding: 10px;
            color: #eee;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }

        /* Utility */
        .badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 11px;
            border-radius: 4px;
            font-weight: 600;
        }

        .badge-pending {
            background: #ffeeba;
            color: #856404;
        }

        .badge-completed {
            background: #d4edda;
            color: #155724;
        }

        /* 2-Column Layout */
        .main-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .col-left {
            flex: 2;
            /* Takes 2/3 of the space */
        }

        .col-right {
            flex: 1;
            /* Takes 1/3 of the space */
        }

        .sticky-card {
            position: sticky;
            top: 20px;
            /* Adjust as needed */
        }
    </style>
</head>

<body>
    <h1>PesaDB Transaction Manager</h1>

    <div class="main-container">
        <!-- LEFT COLUMN: Operations & Benchmarks -->
        <div class="col-left">
            <!-- Add Transaction Card -->
            <div class="card">
                <h3>Add Transaction</h3>
                <div style="display:flex; gap: 10px;">
                    <input type="number" id="id" placeholder="ID (PK)" style="flex:1">
                    <input type="text" id="ref" placeholder="Reference" style="flex:2">
                    <input type="number" id="amt" placeholder="Amount" style="flex:1">
                    <button onclick="addTxn()" style="flex:1">Add Record</button>
                </div>
                <div id="error" class="error"></div>
            </div>

            <!-- Recent Transactions Card -->
            <div class="card">
                <h3>Recent Transactions</h3>
                <table id="txnTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Reference</th>
                            <th>Amount</th>
                            <th>Currency</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <!-- 5k Benchmark Card -->
            <div class="card">
                <h3>Real-Time Performance (5,000 Txns)</h3>
                <p>Simulation of typical financial workflow: Insert -> Read -> Update.</p>

                <div class="metrics-grid">
                    <div class="metric-box">
                        <div class="metric-label">Last Query</div>
                        <div class="metric-value" id="perf-last" style="color: #0056b3">- ms</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Write (ops/s)</div>
                        <div class="metric-value" id="perf-write" style="color: #28a745">-</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Read (ops/s)</div>
                        <div class="metric-value" id="perf-read" style="color: #17a2b8">-</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Update (ops/s)</div>
                        <div class="metric-value" id="perf-update" style="color: #fd7e14">-</div>
                    </div>
                </div>

                <button onclick="runBenchmark()" class="action-btn">Run 5k Record Stress Test</button>
                <div id="bench-status" style="margin-top: 15px; text-align: center; color: #666;"></div>

                <div id="bench-progress" style="display: none; margin-top: 15px; gap: 2px;">
                    <div id="step-1" style="flex:1; background:#eee; padding:5px; text-align:center; font-size:12px;">1.
                        Generate</div>
                    <div id="step-2" style="flex:1; background:#eee; padding:5px; text-align:center; font-size:12px;">2.
                        Index
                        Scan</div>
                    <div id="step-3" style="flex:1; background:#eee; padding:5px; text-align:center; font-size:12px;">3.
                        Bulk
                        Update</div>
                </div>

                <div id="bench-data-view"
                    style="display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top:10px;">
                    <h4 style="font-size:14px; margin:0 0 10px 0;">Benchmark Sample Data</h4>
                    <table style="font-size: 12px;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ref</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="benchTableBody"></tbody>
                    </table>
                    <div style="font-size:11px; color:#888; margin-top:5px;">* Table: <code
                            id="bench-table-name">...</code>
                    </div>
                </div>
            </div>

            <!-- 1M Benchmark Card -->
            <div class="card card-red">
                <h3>1 Million Row Challenge</h3>
                <p>Native C++ Engine Throughput Test (Bypasses SQL Parser)</p>

                <button onclick="run1MBenchmark()" class="action-btn" style="background: #dc3545;">Run 1 Million
                    Inserts</button>

                <div id="term-container-1m" class="terminal-container">
                    <div class="terminal-header">Native Engine Log output</div>
                    <div id="term-content" class="terminal-body"></div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: SQL Console -->
        <div class="col-right">
            <div class="card sticky-card">
                <h3>SQL Console</h3>
                <div style="display:flex; flex-direction: column; gap:10px; margin-bottom:10px;">
                    <textarea id="sqlInput" rows="5"
                        style="width: 100%; font-family: monospace; padding: 10px;">SELECT * FROM employees JOIN departments ON employees.dept_id = departments.id</textarea>
                    <button onclick="runSQL()" style="width: 100%;">Execute SQL Command</button>
                </div>
                <div style="font-size: 12px; margin-bottom: 5px; color: #666;">Output:</div>
                <pre id="sqlOutput"
                    style="background:#eee; padding:10px; border-radius:4px; overflow-x:auto; max-height: 400px;">Results will appear here...</pre>
            </div>
        </div>
    </div>



    <script>
        const API = '/api/sql';

        async function execute(sql) {
            try {
                const res = await fetch(API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sql })
                });
                const json = await res.json();
                if (json.timeMs) {
                    document.getElementById('perf-last').innerText = json.timeMs + ' ms';
                }
                return json;
            } catch (e) {
                return { success: false, error: e.message };
            }
        }

        async function refresh() {
            let res = await execute("SELECT * FROM transactions");

            // Auto-init schema if missing
            if (!res.success && (res.error || "").includes('not found')) {
                await execute("CREATE TABLE transactions (id INT PRIMARY KEY, reference STRING, amount FLOAT)");
                await execute("INSERT INTO transactions VALUES (1, 'INIT-01', 100.50)");
                await execute("INSERT INTO transactions VALUES (2, 'INIT-02', 200.75)");
                res = await execute("SELECT * FROM transactions");
            }

            if (res.success && Array.isArray(res.data)) {
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                res.data.forEach(txn => {
                    const statusClass = txn.status === 'COMPLETED' ? 'badge-completed' : 'badge-pending';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${txn.id}</td>
                        <td>${txn.reference}</td>
                        <td>${txn.amount}</td>
                        <td>${txn.currency || 'KES'}</td>
                        <td><span class="badge ${statusClass}">${txn.status || 'PENDING'}</span></td>
                        <td><button class="delete" onclick="deleteTxn(${txn.id})">Delete</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        async function addTxn() {
            const id = document.getElementById('id').value;
            const ref = document.getElementById('ref').value;
            const amt = document.getElementById('amt').value;
            if (!id || !ref || !amt) return;

            const res = await execute(`INSERT INTO transactions VALUES (${id}, '${ref}', ${amt})`);
            if (res.success) {
                document.getElementById('id').value = '';
                document.getElementById('ref').value = '';
                document.getElementById('amt').value = '';
                document.getElementById('error').innerText = '';
                refresh();
            } else {
                document.getElementById('error').innerText = res.error;
            }
        }

        async function deleteTxn(id) {
            if (!confirm("Delete transaction " + id + "?")) return;
            const res = await execute(`DELETE FROM transactions WHERE id = ${id}`);
            if (res.success) refresh();
            else alert(res.error);
        }

        async function runSQL() {
            const sql = document.getElementById('sqlInput').value;
            const res = await execute(sql);
            document.getElementById('sqlOutput').innerText = JSON.stringify(res, null, 2);
            if (res.success && /INSERT|DELETE|UPDATE|DROP/i.test(sql)) {
                refresh();
            }
        }

        // --- 5k Benchmark Logic ---
        async function runBenchmark() {
            const btn = document.querySelector('button[onclick="runBenchmark()"]');
            const status = document.getElementById('bench-status');
            const s1 = document.getElementById('step-1');
            const s2 = document.getElementById('step-2');
            const s3 = document.getElementById('step-3');

            const setActive = (el) => { el.style.background = '#0056b3'; el.style.color = 'white'; };
            const setDone = (el) => { el.style.background = '#d4edda'; el.style.color = '#155724'; };
            const reset = () => [s1, s2, s3].forEach(el => { el.style.background = '#eee'; el.style.color = '#333'; });

            btn.disabled = true;
            btn.innerText = "Running...";
            document.getElementById('bench-progress').style.display = 'flex';
            reset();

            try {
                const response = await fetch('/api/benchmark', { method: 'POST' });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const lines = decoder.decode(value, { stream: true }).split('\n');
                    for (const line of lines) {
                        if (line.includes("Starting 5,000 Inserts")) { setActive(s1); status.innerText = "Step 1: Inserting..."; }
                        else if (line.includes("Inserts completed")) setDone(s1);
                        else if (line.includes("Starting 5,000 Indexed Reads")) { setActive(s2); status.innerText = "Step 2: Reading..."; }
                        else if (line.includes("Reads completed")) setDone(s2);
                        else if (line.includes("Starting Bulk Update")) { setActive(s3); status.innerText = "Step 3: Updating..."; }
                        else if (line.includes("Bulk Update completed")) setDone(s3);
                        else if (line.startsWith("RESULT:")) {
                            const data = JSON.parse(line.substring(7));
                            if (data.success) {
                                status.innerText = "Benchmark Complete";
                                document.getElementById('perf-write').innerText = data.metrics.insertSpeed;
                                document.getElementById('perf-read').innerText = data.metrics.readSpeed;
                                document.getElementById('perf-update').innerText = data.metrics.updateSpeed;
                                document.getElementById('bench-table-name').innerText = data.tableName;

                                // Load sample
                                const sampleRes = await execute(`SELECT * FROM ${data.tableName} LIMIT 5`);
                                if (sampleRes.success) {
                                    document.getElementById('bench-data-view').style.display = 'block';
                                    document.getElementById('benchTableBody').innerHTML = sampleRes.data.map(r =>
                                        `<tr><td>${r.id}</td><td>${r.ref}</td><td>${r.amount}</td><td>${r.status}</td></tr>`
                                    ).join('');
                                    // Auto-fill and RUN SQL Console
                                    document.getElementById('sqlInput').value = `SELECT * FROM ${data.tableName} LIMIT 20`;
                                    runSQL();
                                }
                            } else {
                                status.innerText = "Failed: " + data.error;
                            }
                        }
                    }
                }
            } catch (e) {
                status.innerText = "Error: " + e.message;
            }
            btn.disabled = false;
            btn.innerText = "Run 5k Record Stress Test";
        }

        // --- 1M Benchmark Logic ---
        async function run1MBenchmark() {
            const btn = document.querySelector('button[onclick="run1MBenchmark()"]');
            const container = document.getElementById('term-container-1m');
            const content = document.getElementById('term-content');

            btn.disabled = true;
            btn.innerText = "Processing...";
            container.style.display = 'block';
            content.innerHTML = '> Initializing Native Engine...\n';

            try {
                const response = await fetch('/api/bench/1m', { method: 'POST' });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const lines = decoder.decode(value, { stream: true }).split('\n');

                    for (const line of lines) {
                        if (line.startsWith("LOG:")) {
                            content.innerHTML += `> ${line.substring(4)}<br>`;
                            content.scrollTop = content.scrollHeight;
                        } else if (line.trim() === "DONE") {
                            content.innerHTML += `> DONE. Check Metrics.<br>`;
                        }
                    }
                }
            } catch (e) {
                content.innerHTML += `> ERROR: ${e.message}<br>`;
            }
            btn.disabled = false;
            btn.innerText = "Run 1 Million Inserts";
        }

        refresh();
    </script>
</body>

</html>